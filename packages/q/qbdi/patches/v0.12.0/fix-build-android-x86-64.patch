From 15856c17168b1bc4f8a6794ddf9babf636409e67 Mon Sep 17 00:00:00 2001
From: Redbeanw44602 <redbeana44945@gmail.com>
Date: Fri, 2 Jan 2026 22:08:04 +0800
Subject: [PATCH] fix: don't use asm dialect under android.

---
 CMakeLists.txt                      | 8 ++++++--
 src/ExecBlock/X86_64/CMakeLists.txt | 4 ++--
 src/Utility/X86_64/CMakeLists.txt   | 4 ++--
 3 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 76a3517..0112619 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -253,8 +253,12 @@ if(QBDI_PLATFORM_WINDOWS)
   enable_language(ASM_MASM)
   set(ASM_EXT "asm")
 elseif(QBDI_ARCH_X86 OR QBDI_ARCH_X86_64)
-  set(CMAKE_ASM-ATT_COMPILER ${AS_BINARY})
-  enable_language(ASM-ATT)
+  if (NOT QBDI_PLATFORM_ANDROID)
+    set(CMAKE_ASM-ATT_COMPILER ${AS_BINARY})
+    enable_language(ASM-ATT)
+  else()
+    enable_language(ASM)
+  endif()
   set(ASM_EXT "s")
   if(QBDI_PLATFORM_OSX AND QBDI_ARCH_X86)
     set(CMAKE_ASM-ATT_FLAGS "-arch i386")
diff --git a/src/ExecBlock/X86_64/CMakeLists.txt b/src/ExecBlock/X86_64/CMakeLists.txt
index a170a06..b4c0c12 100644
--- a/src/ExecBlock/X86_64/CMakeLists.txt
+++ b/src/ExecBlock/X86_64/CMakeLists.txt
@@ -17,8 +17,8 @@ elseif(QBDI_PLATFORM_LINUX OR QBDI_PLATFORM_ANDROID)
     set(ASM_STUB_EXECBLOCK "${CMAKE_CURRENT_LIST_DIR}/linux_X86.s")
   endif()
   list(APPEND SOURCES "${ASM_STUB_EXECBLOCK}")
-  set_property(SOURCE "${ASM_STUB_EXECBLOCK}" PROPERTY COMPILE_FLAGS
-                                                       --noexecstack)
+  set_property(SOURCE "${ASM_STUB_EXECBLOCK}" PROPERTY LINK_FLAGS
+                                                       "-Wl,-z,noexecstack")
 
 elseif(QBDI_PLATFORM_WINDOWS)
 
diff --git a/src/Utility/X86_64/CMakeLists.txt b/src/Utility/X86_64/CMakeLists.txt
index 2901fa3..645ca51 100644
--- a/src/Utility/X86_64/CMakeLists.txt
+++ b/src/Utility/X86_64/CMakeLists.txt
@@ -16,8 +16,8 @@ elseif(QBDI_PLATFORM_LINUX OR QBDI_PLATFORM_ANDROID)
     set(ASM_STUB_UTILITY "${CMAKE_CURRENT_LIST_DIR}/linux-X86.s")
   endif()
   list(APPEND SOURCES "${ASM_STUB_UTILITY}")
-  set_property(SOURCE "${ASM_STUB_UTILITY}" PROPERTY COMPILE_FLAGS
-                                                     --noexecstack)
+  set_property(SOURCE "${ASM_STUB_UTILITY}" PROPERTY LINK_FLAGS
+                                                     "-Wl,-z,noexecstack")
 
 elseif(QBDI_PLATFORM_WINDOWS)
 
-- 
2.52.0

